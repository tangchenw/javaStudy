## 什么是2-3树？

日常的学习和一部分伙伴的面试中，竟然会听👂到的是；从HashMap中文红黑树、从数据库索引为B+Tree，但问2-3树的情况就不是很多了。

### 1. 为什么使用树结构

从最根本的原因来看，使用树结构就是为了提升整体的效率；插入、删除、查找(索引)，尤其是索引操作。因为相比于链表，一个平衡树的索引时间复杂度是O(logn)，而链表的索引时间复杂度是O(n)。

![公众号：bugstack虫洞栈 & 链表与二叉搜索树(Binary Search Tree)时间复杂度对比](https://bugstack.cn/assets/images/2020/interview/interview-6-01.png)

- 从上图可以看到，使用树结构有效的降低时间复杂度，提升数据索引效率。
- 另外这个标准的树结构，是二叉搜索树(Binary Search Tree)。除此之外树形结构还有；AVL树、红黑树、2-3树等

### 2. 二叉搜索树退化链表

在树的数据结构中，最先有点是二叉查找树，也就是英文缩写BST树。在使用数据插入的过程中，理想情况下它是一个平衡的二叉树，但实际上可能会出现二叉树都一边倒，让二叉树像列表一样的数据结构。从而树形结构的时间复杂度也从`O(logn)`升级到`O(n)`，如下图；

![公众号：bugstack虫洞栈 & 二叉搜索树退化链表 ](https://bugstack.cn/assets/images/2020/interview/interview-6-02.png)

- 二叉搜索树的数据插入过程是，插入节点与当前树节点做比对，小于在左，大于在右。
- 随着数据的插入顺序不同，就会出现完全不同的数据结构。可能是一棵平衡二叉树，也极有可能退化成链表的树。
- 当树结构退化成链表以后，整个树索引的性能也跟着退化成链表。

**综上呢，如果我们希望在插入数据后又保持树的特点，O(logn)的索引性能，那么就需要在插入时进行节点的调整**

### 3. 2-3树解决平衡问题

*2-3树是什么结构，它怎么解决平衡问题的。带着问题我们继续🤔。*

2-3树是一种非常巧妙的结构，在保持树结构的基础上，它允许在一个节点中可以有两个元素，等元素数量等于3个时候再进行调整。通过这种方式呢，来保证整个二叉搜索树的平衡性。

**这样说可能还没有感觉，来看下图；**

![公众号：bugstack虫洞栈 & 2-3树解决平稳问题](https://bugstack.cn/assets/images/2020/interview/interview-6-03.png)

- 左侧是二叉搜索树，右侧是2-3平衡树，分别插入节点4、5，观察树形结构变化。
- 二叉搜索树开始出现偏移，节点一遍倒。
- 2-3树通过一个节点中存放2到3个元素，来调整树形结构，保持平衡。*所谓的保持平衡就是从根节点，到每一个最底部的自己点，链路长度一致。*

2-3树已经可以解决平衡问题**那么，数据是怎么存放和调整的呢，接下来我们开始分析。**

### 4. 2-3树使用

#### 树结构定义和特点性质

**2-3树，读法；二三树**，特性如下；

| 序号 | 描述                                                         | 示意图                                                       |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | 2-，1个数据节点2个树杈                                       | ![img](https://bugstack.cn/assets/images/2020/interview/interview-6-04.png) |
| 2    | 3-，2个数据节点3个树杈                                       | ![img](https://bugstack.cn/assets/images/2020/interview/interview-6-05.png) |
| 3    | 三叉与两叉的不同点在于，除了两边的节点，中间件还有一个节点。这个节点是介于2、4之间的值。 | ![img](https://bugstack.cn/assets/images/2020/interview/interview-6-06.png) |
| 4    | 当随着插入数据，会出现临时的一个节点中，有三个元素。这时会被调整成一个二叉树。 | ![img](https://bugstack.cn/assets/images/2020/interview/interview-6-07.png) |

**综上我们可以总结出，2-3树的一些性质；**

1. 2-3树所有子叶节点都在同一层
2. 1个节点可以有1到2个数据，如果有三个需要调整树结构
3. 1个节点1个数据时，则有两个子节点
4. 1个节点2个数据时，则有三个子节点，且中间子节点是介于两个节点间的值

#### 数据插入

接下来我们就模拟在二叉搜索树中退化成链表的数据，插入到2-3树的变化过程，数据包括；`1、2、3、4、5、6、7`，插入过程图如下；

![公众号：bugstack虫洞栈 & 数据插入过程图](https://bugstack.cn/assets/images/2020/interview/interview-6-08.png)

**以上，就是整个数据在插入过程中，2-3树的演化过程**，接下来我们具体讲解每一步的变化；

- α，向节点1插入数据2，此时为了保持平衡，不会新产生分支，只会在一个节点中存放两个节点。
- β，继续插入数据3，此时这个节点有三数据，1、2、3，是一个临时区域。
- γ，把三个数据的节点，中间节点拉起来，调整成树形结构。
- δ，继续插入数据4，为了保持树平衡，会插在节点3的右侧。
- ε，继续插入数据5，插入后`3、4、5`共用1个节点，当一个节点上有三个数据时候，则需要进行调整。
- ζ，中间节点4向上⏫调整，调整后，1节点在左、3节点在中间、5节点在右。
- η ，继续插入数据6，在保持树平衡的情况下，与节点5公用。
- θ ，继续插入数据7，插入后，节点7会与当前的节点 `5 6` 共用。此时是一个临时存放，需要调整。初步调整后，抽出6节点，向上存放，变为`2 4 6`共用一个节点，这是一个临时状态，还需要继续调整。
- ι，因为根节点有三个数据`2、4、6`，则继续需要把中间节点上移，`1、3`和`5、7` 则分别成二叉落到`节点2`、`节点6`上。

*🇬🇷希腊字母：α(阿尔法)、 β(贝塔)、γ(伽马)、δ(德尔塔)、ε(伊普西隆)、ζ(截塔)、η(艾塔)、θ(西塔)、ι(约塔)*

#### 数据删除

有了上面数据插入的学习，在看数据删除其实就是一个逆向的过程，在删除的主要包括这样两种情况；

1. 删除了3-节点，也就是包含两个数据元素的节点，直接删除即可，不会破坏树平衡。
2. 删除了2-节点，此时会破坏树平衡，需要将树高缩短或者元素合并，恢复树平衡。

承接上面👆的例子，我们把数据再从`7、6、5、4、3、2、1`顺序删除，观察2-3树的结构变化，如下；

![公众号：bugstack虫洞栈 & 数据删除过程图](https://bugstack.cn/assets/images/2020/interview/interview-6-09.png)

**再看一个稍微复杂点2-3树删除：**

![公众号：bugstack虫洞栈 & 复杂树删除过程](https://bugstack.cn/assets/images/2020/interview/interview-6-10.png)

上面👆这张图，就一个稍微复杂点的2-3平衡树，树的删除过程主要包括；

1. 删除4，其实需要将节点`3、5`合并，指向节点2，保持树平衡。
2. 删除7，节点`8、9`合并。
3. 删除14，节点`15`上移，恢复成3-叉树。

*🤔如果有时候不好理解删除，可以试想下，这个要删除的节点，在插入的时候是一个什么效果。*

#### 数据索引

相比于插入和删除，索引的过程还是比较简单的，不需要调整数据结果。基本原则就是；

1. 小于当前节点值，左侧寻找
2. 大于当前节点值，右侧寻找
3. 一直到找到索引值，停止。

**🔍第一层寻找：**

![img](https://bugstack.cn/assets/images/2020/interview/interview-6-11.png)

**🔍第二层寻找：**

![img](https://bugstack.cn/assets/images/2020/interview/interview-6-12.png)

**🔍第三次寻找：**

![img](https://bugstack.cn/assets/images/2020/interview/interview-6-13.png)

## 红黑树

### 1. 2-3树与红黑树的等价性

**红黑树规则**

```java
1. 根节点是黑色
2. 节点是红黑或者黑色
3. 所有子叶节点都是黑色(叶子是NIL节点，默认没有画出来)
4. 每个红色节点必须有两个黑色子节点(也同样说明一条链路上不能有链路的红色节点)
5. 黑高，从任一节点到齐每个叶子节点，经过的路径都包含相同数目的黑色节点
```

### 2. 为什么既有2-3树要有红黑树

首先`2-3树`(*读法：二三树*)就是一个节点有1个或者2个元素，而实际上2-3树转红黑树是由概念模型`2-3-4树`转换而来的。`-4叉`就是一个节点里有3个元素，这在2-3树中会被调整，但是在概念模型中是会被保留的。

虽然`2-3-4树`也是具备`2-3树`同样的平衡树的特性，但是如果直接把这样的模型用代码实现就会很麻烦，且效率不高，这里的复杂点包括；

1. 2-叉、3-叉、4-叉，三种结构的节点类型，互相转换复杂度较高
2. 3-叉、4-叉，节点在数据比较上需要进行多次，不像2-叉节点，直接布尔类型比较即可*非左即右*
3. 代码实现上对每种差异，都需要有额外的代码，规则不够标准化

**所以**，希望找到一种平衡关系，既保持2-3树平衡和O(logn)的特性，又能在代码实现上更加方便，那么就诞生了红黑树。

### 3. 简单2-3树转红黑树

`2-3树`转红黑树，也可以说红黑树是`2-3树`和`2-3-4树`的另外一种表现形式，也就是更利于编码实现的形式。

**简单转换示例；**

![2-叉、3-叉、4-叉，转换红黑树示意图](https://bugstack.cn/assets/images/2020/interview/interview-7-01.png)

从上图可以看出，2-3-4树与红黑树的转换关系，包括；

1. 2-叉节点，转换比较简单，只是把原有节点转换为黑色节点
2. 3-叉节点，包括了2个元素，先用红色线把两个节点相连，之后拆分出来，最后调整高度*黑色节点在上*
3. 4-叉节点，包括了3个元素，分别用红黑线连接，之后拆分出来拉升高度。*这个拉升过程和2-3树调整一致，只是添加了颜色*

**综上**，就是2-3-4树的节点转换，总结出来的规则，如下；

1. 将2-3-4树，用二叉树的形式表示
2. 3-叉、4-叉节点，使用红色、黑色连线进行连接
3. 另外，3-叉节点有两种情况，导致转换成二叉树，就有左倾和右倾

### 4. 复杂2-3树转红黑树

在`简单2-3树转换红黑树`的过程中，了解到一个基本的转换规则右旋定义，接下来我们在一个稍微复杂一点的`2-3树`与红黑树的对应关系，如下图；

![复杂2-3树转换红黑树](https://bugstack.cn/assets/images/2020/interview/interview-7-02.png)

上图是一个稍微复杂点的2-3树，转换为红黑树的过程，是不这样一张图让你对红黑树更有感觉了，同时它也满足一下条件；

1. 从任意节点到叶子节点，所经过的黑色节点数目相同
2. 黑色节点保持着整体的平衡性，也就是让整个红黑树接近于O(logn)时间复杂度
3. 其他红黑树的特点也都满足，可以对照红黑树的特性进行比对

#### 左旋转

**左旋定义：** 把一个向右倾斜的红节点链接(2-3树，3-叉双元素节点)，转化为左链接。

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-03.png)

背景：顺序插入元素，1、2、3，2-3树保持平衡，红黑树暂时处于右倾斜。

接下来我们分别对比两种树结构的平衡操作；

1. 2-3树，所有插入的节点都会保持在一个节点上，之后通过调整节点位置，保持平衡。
2. 红黑树，则需要通过节点的左侧旋转，将元素2拉起来，元素1和元素3，分别成为左右子节点。

*红黑树的左旋，只会处理与之对应的2-3树节点进行操作，不会整体改变。*

#### 右旋转

**右旋定义：** 把一个向左倾斜的红节点连接(2-3树，3-叉双元素节点)，转换为右连接。

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-04.png)

背景：顺序插入元素，3、1、1，2-3树保持平衡，红黑树暂时处于左倾斜。

接下来我们分别对比两种树结构的平衡操作；

1. 2-3树，所有插入的节点都会保持在一个节点上，之后通过调整节点位置，保持平衡。
2. 红黑树，则需要通过节点的右侧旋转，将元素2拉起来，元素1和元素3，分别成为左右子节点。

**你会发现，左旋与右旋是相互对应的，但在2-3树中是保持不变的**

#### 左右旋综合运用

左旋、右旋，我们已经有了一个基本的概念，那么接下来我们再看一个可以综合左右旋以及对应2-3树的演化案例，如下；

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-05.png)

以上的例子分别演示了一个元素插入的三种情况，如下；

1. 1、3，插入0，左侧底部插入，与2-3树相比，需要右旋保持平衡
2. 1、3，插入2，中间位置插入，首先进行左旋调整元素位置，之后进行右旋进行树平衡
3. 1、3，插入5，右侧位置插入，此时正好保持树平衡，不需要调整

#### 染色

在2-3树中，插入一个节点，为了保持树平衡是不插入到空位置上的，当插入节点后元素数量有3个后则需要调整中间元素向上，来保持树平衡。与之对应的红黑树则需要调整颜色，来保证红黑树的平衡规则，具体参考如下；

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-06.png)

#### 旋转+染色运用案例

接下来我们把上面讲解到的`旋转`、`染色`，运用到一个实际案例中，如下图；

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-07.png)

- 首先从左侧开始，是一个按照顺序插入生产出来的红黑树，插入顺序；`7、2、8、1、4、3、5`
- α，向目前红黑树插入元素6，插入后右下角有三个红色节点；`3、5、6`。
- β，因为右下角满足染色条件，变换后；黑色节点(3、5)、红色节点(4、6)。
- γ，之后看被红色连线链接的节点`7、4、2`，最小节点在中间，左旋平衡树结构。
- δ，左旋完成后，红色链接线的`7、4、2`为做倾顺序节点，因此需要做右旋操作。
- ε，左旋、右旋，调整完成后，又满足了染色操作。到此恢复红黑树平衡。

*注意，所有连接红色节点的，都是是红色线。以此与2-3树做对应。*

#### 删除操作

根据2-3-4树模型的红黑树，在删除的时候基本是按照2-3方式进行删除，只不过在这个过程中需要染色和旋转操作，以保持树平衡。删除过程主要可以分为如图四种情况，如下；

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-08.png)

**删除子叶红色节点**

红色子叶节点的删除并不会破坏树平衡，也不影响树高，所以直接删除即可，如下；

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-09.png)

**删除左侧节点**

被删节点兄弟为黑色&含右子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-10.png)

被删节点兄弟为黑色&含左子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-11.png)

被删节点兄弟为黑色&含双子节点(红)

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-12.png)

被删节点兄弟为黑色&不含子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-13.png)

被删节点兄弟为黑色&含双黑节点(黑)

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-14.png)

**删除右侧节点**

被删节点兄弟为黑色&含左子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-15.png)

被删节点兄弟为黑色&含右子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-16.png)

被删节点兄弟为黑色&含双子节点(红)

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-17.png)

被删节点兄弟为黑色&不含子节点

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-18.png)

被删节点兄弟为黑色&含双黑节点(黑)

![img](https://bugstack.cn/assets/images/2020/interview/interview-7-19.png)
